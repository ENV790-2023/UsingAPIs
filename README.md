# Cloud-based GIS: Using REST-based APIs
## Overview

In this tutorial we explore the application of web services to spatial analysis. It’s an exciting and rapidly evolving field: what’s “cutting edge” this year is likely to be old news the next. However, getting in on this technology at an early stage should provide you with a more robust understanding of how it works and thus how you can utilize its power most effectively. At this stage in the development of web services and cloud-based GIS, however, you’ll need to be prepared for bugs and limited documentation. It’s all part of the excitement of being at the forefront of technology.

Here, we begin simply, looking at web services from within web browsers. From there we explore how these services can be controlled via scripts (e.g. Python). Then we examine more advanced interfaces to web services, i.e. via APIs and applications that are integrated with web services (e.g. ArcGIS.com and Desktop ArcGIS).

## Lesson Objectives

* Understand what REST is, in the context of using cloud-based resources
* Identify and implement APIs to fetch data and execute analyses
* Master the use of the Python `requests` library to form and send requests to APIs and handle their responses

---

## What is REST

**REST** (**Re**presentational State **T**ransfer) is a set of principles that govern the design of web services, including APIs (Application Programming Interfaces). RESTful APIs provide a way for two software applications to communicate with each other over the internet.

At its core, REST is a way to structure communication between a client (such as a web browser or mobile app) and a server (such as a web application or database). The principles of REST define a standard way of accessing and manipulating resources (such as data or files) over the internet using HTTP (Hypertext Transfer Protocol).

RESTful APIs typically use HTTP methods (such as GET, POST, PUT, and DELETE) to perform actions on resources. For example, a client can use an HTTP GET request to retrieve information about a resource, such as a user account or a product listing. A client can use an HTTP POST request to create a new resource, such as a new user account or a new product listing.

RESTful APIs also use URLs (Uniform Resource Locators) to identify resources. For example, a URL might be used to identify a specific product listing, such as https://example.com/products/12345. This URL could be used with an HTTP GET request to retrieve information about the product, or with an HTTP PUT request to update the product information.

Overall, RESTful APIs provide a standard way for software applications to communicate with each other over the internet, making it easier for developers to build software that can interact with other systems and services. It is a simple, yet powerful means for expanding spatial analysis, among other tasks, beyond the desktop. 

### REST: An Example

Each time you do something as familiar as a Google search, you are using REST. Give it a try: 

* **Navigate to <https://www.google.com> and search search for "Duke University".**  
  The results are not surprising, but if you look at the web address (i.e. the URL) for the search results page, you'll see your search term (among other things) in it, likely followed by a `q=`. *This URL is a REST-based request!*
* **Copy, paste, and enter the following URL into your browser:**  
  [https://www.google.com/search?q=Nicholas School of the Environment](https://www.google.com/search?q=Nicholas School of the Environment)  
  Here, instead of using Google's familiar search page to enter a search term, we performed the search by issuing the REST based request directly, as a URL. 
* **Try modifying the URL to search for something else**...

So we see that a Google Search acts like REST API where the phrase following the `q=` is the search parameter. 

> **The structure of the Google Search API:**
>
> | URL component                          | Purpose                                                      |
> | -------------------------------------- | ------------------------------------------------------------ |
> | `https://www.google.com`               | The address to where the request should be sent. <br />(This can also include sub folders...) |
> | `search`                               | The request function.                                        |
> | `q=Nicholas School of the Environment` | A parameter of the request function and its value.           |



One key takeaway about REST based APIs is that <u>the entire request-response transaction is done via text</u>: The request, which is sent as a URL is text, and the response generated by the server also takes the form as text. 

---

## Geospatial APIs

Any APIs that include location in the request, perform some sort of spatial query, or that return spatial data can be considered a geospatial API. Some geospatial API's are quite straightforward with fairly simple URL request formats; for example, you include longitude and latitude coordinates to specify a location, and the API returns some description of that location. Other geospatial APIs, however, might require complex spatial features and coordinate reference system information to execute. So let's explore how that is done by looking at a few example geospatial APIs. 

 ### Google Maps

We turn again to Google for an example we've all used but never thought about as an API. 

* **Open Google Maps**: <https://www.google.com/maps>
* Swipe the map in any direction: does the URL change? 
* Edit the URL to move the map to `19.4331656,-99.1302183`. Where is the map centered now? 
* In the Search box, type "Duke University" and run the search. Do you see your search term in the URL? 
* Modify the URL to navigate the map to a different location...
* Does the URL follow the same format as the Google Search API URL? 
* Try this URL: [https://www.google.com/maps/@36.0044908,-78.9423673,21,15z](https://www.google.com/maps/@36.0044908,-78.9423673,21,15z)



### USGS Hydro-Network Linked Data APIs

Now we'll examine a more purposeful API,. i.e., one specifically designed to be used programmatically (vs via a browser). Many governmental data collection agencies now provide APIs for access to data. Here we'll look at the USGS's Hydro Network Linked Data Index (NLDI) API resource page and invoke one of their geospatial APIs to fetch the NHD+ catchment ID, or "COMID", for any location (in the continental US) that we provide. 

* Navigate to the USGS API resource page: https://labs.waterdata.usgs.gov/about-nldi/index.html
  * Familiarize yourself with the documentation and what data these services provide access to.
* Scroll down to the "`Discover a starting network id (`comid`) with the “position” function.`" API. 
* Click the [link](https://labs.waterdata.usgs.gov/api/nldi/linked-data/comid/position?coords=POINT(-89.35%2043.0864)). You'll likely get a warning that results aren't meant to be shown as HTML, but rather as JSON. Click the link to show it in JSON.
  * *:point_right:Did anything change in the URL when you clicked the link to show in JSON format??*
* Do you see the COMID for the location provided? 
* <mark>What is the COMID for the catchment the LSRC is in? (Use Google Maps to fetch the coordinates of the LSRC...)</mark>



### ESRI REST API

Nearly all data available via AGOL can be retrieved via REST. As we've explored in class, all AGOL data item pages include links to their REST endpoints. And other organizations who share data not on ESRI's AGOL portal, but rather on their own enterprise AGOL site, also provide access to their data via REST. In short, there are a LOT of datasets we can work with via REST...

> ► **TIP**: A web search that includes `arcgis/rest` may lead to some useful data sources!

Let's have a look at some NC data stored on the NC OneMap REST endpoint. *During each step, be sure to note how the URL changes...*

* Navigate to <https://services.nconemap.gov/secure/rest/services> to view a listing of the services. Note the organization of services: some are here while others are in folders. 

* Click the link to the [Parcels Feature Server](https://services.nconemap.gov/secure/rest/services/NC1Map_Parcels/FeatureServer).

* Note that this Feature Service has two layers: *Parcel Centroids* (at index `0`), and *Parcels* (at index `1`).

* Click the link to the [Parcels features](https://services.nconemap.gov/secure/rest/services/NC1Map_Parcels/FeatureServer/1). 

  * <mark>What is the spatial reference of this dataset?</mark>
  * Also, familiarize yourself with the fields included in this feature layer. <mark>Take note of the fieldname holding the object ID of each records</mark>>

* Click on the `[Query](https://services.nconemap.gov/secure/rest/services/NC1Map_Parcels/FeatureServer/1/query)` link at the very bottom of the page.

* In the resulting query form enter the following and the click  `Query (GET)`.

  * **Where**: `1 = 1`
  * **Out Fields** = `*`
  * **Result Record Count** = `3`

  *The "Where" clause here is a placeholder that will return all records.  Setting the Out Fields to \* returns all the fields. And setting the Result Record Counnt to three limits the output to the first 3 records -- to save time...*

* Scroll down to the bottom of the page to see the results of the query. In particular, note the values corresponding to the `cntyname` field: `Bladen`

* Modify the query: 

  * **Where**: `cntyname = 'Durham`'
  * **Return Geometry**: False
  * **Return Count Only**: True
  * **Result Record Count**: <blank>

  <mark>How many parcels in Durham County?</mark>

* Modify the Where clause to `ownname LIKE '%FAY' AND cntyname = 'Durham'`. 

  <mark>How many parcels are owned by people with the last name FAY?</mark>

At each iteration, the query forms a new URL and sends it off to the NC OneMap enterprise server. It's a long URL as it contains placeholder for every query option, but it can be distilled to this:

```http
https://services.nconemap.gov/secure/rest/services/NC1Map_Parcels/FeatureServer/1/query?where=ownname+LIKE+%27%25FAY%27+AND+cntyname+%3D+%27Durham%27&returnCountOnly=true&f=html
```

> Note that special characters like `%`, `&`, and spaces are translated into encoded formats. See more here: https://www.w3schools.com/tags/ref_urlencode.ASP

* Modify the URL changing, the last argument from &f=html to `f=pjson`
* The response now takes the form of a JSON object, which is better programmatically. 

---

## Making REST API calls outside the browser

Web browsers, as we just demonstrated, are well adapted to making REST based requests and also handling their responses. Typically, the responses are in the form of HTML, which the browser interprets to form well structured web pages. Often embedded in this HTML are JavaScript commands, which browsers understand and can run making for some quite fancy elements in a web page. 

Still, the response is just text, and you don't necessarily need a browser to make use of a response, let alone to send a request to a REST based API. Python has a few packages that work well in interacting with REST based APIs. To explore these, we'll move the lesson to Jupyter notebooks. 

